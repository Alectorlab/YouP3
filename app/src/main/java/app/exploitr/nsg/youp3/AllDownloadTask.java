package app.exploitr.nsg.youp3;

import android.content.Context;
import android.content.DialogInterface;
import android.os.AsyncTask;
import android.support.annotation.NonNull;
import android.support.design.widget.Snackbar;
import android.support.v7.app.AlertDialog;
import android.support.v7.app.AppCompatActivity;
import android.util.Log;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.ListView;
import android.widget.TextView;

import com.koushikdutta.ion.Ion;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.util.ArrayList;

/**
 * Created by exploitr on 14-08-2017.
 * <p>
 * TODO
 */

class AllDownloadTask extends AsyncTask<String,Void,Void> {

    private static final String TAG = "DownloadTask";

    private Context mContext;
    private View mView;
    private String title,responseString;
    private AppCompatActivity mActivity;
    private ArrayList<String> urlList;
    private ArrayList<String> labelList;

    private JSONArray links;
    private JSONObject last,response;



    AllDownloadTask(AppCompatActivity activity, View screenView) {
        this.mActivity = activity;
        this.mContext = screenView.getContext();
        this.mView = screenView;
    }

    @NonNull
    private static String fileExtension(String fileTitle) {
        if (fileTitle.contains("MP4") | fileTitle.contains("mp4")) {
            return "mp4";
        } else if (fileTitle.contains("webm") | fileTitle.contains("WEBM")) {
            return "webm";
        } else if (fileTitle.contains("3GP") | fileTitle.contains("3gp")) {
            return "3gp";
        } else if (fileTitle.contains("m4a") | fileTitle.contains("M4A")) {
            return "m4a";
        } else if (fileTitle.contains("MP3") | fileTitle.contains("mp3")) {
            return "mp3";
        } else {
            return "mp4";
        }
    }


    @Override
    protected Void doInBackground(String... params) {

        try {
            responseString = Ion.with(mContext).load("https://www.saveitoffline.com/process/?url=" + params[0] + "&type=json").asString().get();
        } catch (Exception e) {
            e.printStackTrace();
            e.getSuppressed();
            Snackbar.make(mView, "Unknown Error", Snackbar.LENGTH_SHORT).show();
        }

        try {
            response = new JSONObject(responseString);
        } catch (JSONException e) {
            e.printStackTrace();
                e.getSuppressed();
            Snackbar.make(mView, "Unknown Error", Snackbar.LENGTH_SHORT).show();
        }

        try {
            title = response.getString("title").replaceAll("[^a-zA-Z0-9.-]", " ").replaceAll("^ +| +$|( )+", "$1");
            links = new JSONArray(response.getString("urls"));
        } catch (Exception e) {
            e.printStackTrace();
            e.getSuppressed();
            Snackbar.make(mView, "Unknown Error", Snackbar.LENGTH_SHORT).show();
        }

        urlList = new ArrayList<>();
        labelList = new ArrayList<>();

        for (int n = 0; n < links.length(); n++) {
            try {
                last = links.getJSONObject(n);
            } catch (Exception e) {
                e.printStackTrace();
                e.getSuppressed();
                Snackbar.make(mView, "Unknown Error", Snackbar.LENGTH_SHORT).show();
            }

            try {
                urlList.add(n, last.getString("id"));
                labelList.add(n, last.getString("label"));
            } catch (Exception e) {
                e.printStackTrace();
                e.getSuppressed();
                Snackbar.make(mView, "Unknown Error", Snackbar.LENGTH_SHORT).show();
            }
        }
        return null;
    }

    @Override
    protected void onPostExecute(Void aVoid) {
        View linkView = mActivity.getLayoutInflater().inflate(R.layout.view_list, null);

        Log.v(TAG, labelList.toString());

        ListView listView = (ListView) linkView.findViewById(R.id.list);

        TextView videoName = (TextView) linkView.findViewById(R.id.videoName);

        videoName.setText(title);

        ArrayAdapter<?> adapter = new ArrayAdapter<Object>(mActivity, R.layout.list_text, R.id.textList, labelList.toArray(new String[0]));

        adapter.notifyDataSetChanged();
        listView.setAdapter(adapter);

        listView.setOnItemClickListener(new AdapterView.OnItemClickListener() {
            @Override
            public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
                String extension = fileExtension(labelList.get(position));
                new MultiDownloader(title, labelList.get(position), extension, mContext, mView).CheckAndGet(urlList.get(position));
            }
        });

        new AlertDialog.Builder(mContext)
                .setView(linkView)
                .setPositiveButton("Dismiss", new DialogInterface.OnClickListener() {
                    @Override
                    public void onClick(DialogInterface dialog, int which) {
                        dialog.dismiss();
                    }
                })
                .show();
        super.onPostExecute(aVoid);
    }
}
