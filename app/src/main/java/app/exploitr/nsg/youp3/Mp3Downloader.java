package app.exploitr.nsg.youp3;

import android.app.DownloadManager;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.database.Cursor;
import android.net.Uri;
import android.os.AsyncTask;
import android.os.Build;
import android.os.Environment;
import android.support.design.widget.Snackbar;
import android.view.View;
import android.widget.Toast;

import java.io.File;
import java.net.HttpURLConnection;
import java.net.URL;


/**
 * Created by exploitr on 23-07-2017.
 * <p>
 * TODO :-) :-) :-) :-) :-) [ Put the TODO block just to highlight this line on IDE ]
 */

class Mp3Downloader extends AsyncTask<String, String, String> {


    private String newLink;
    private Context mContext;
    private String title;
    private File file;
    private View mView;
    private Cursor cursor;
    private DownloadManager manager;
    private BroadcastReceiver afterDownload;
    private long downloadID,fileLength;


    Mp3Downloader(String titlex, Context context, View viewpass) {
        this.mContext = context;
        this.title = titlex;
        this.mView = viewpass;
    }

    @Override
    protected void onPreExecute() {
        super.onPreExecute();

        Toast.makeText(mContext, "Download Started", Toast.LENGTH_SHORT).show();

        file = new File(Environment.getExternalStorageDirectory().getPath() + "/YouP3/" + title + ".mp3");
        if (file.exists()) file.delete();
        file.setWritable(true);
        file.setReadable(true);
    }

    @Override
    protected String doInBackground(String... params) {

        try {
            HttpURLConnection connection = (HttpURLConnection) new URL(params[0]).openConnection();
            connection.connect();
            newLink = String.valueOf(connection.getURL());
        } catch (Exception e) {
            e.printStackTrace();
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
                e.getSuppressed();
            }
        }
        return newLink;
    }

    @Override
    protected void onPostExecute(final String link) {

        afterDownload = new BroadcastReceiver() {
            @Override
            public void onReceive(Context context, Intent intent) {
                System.out.println("Download Finished");
                String action = intent.getAction();
                if (DownloadManager.ACTION_DOWNLOAD_COMPLETE.equals(action)) {
                    long enqueue = intent.getLongExtra(
                            DownloadManager.EXTRA_DOWNLOAD_ID, 0);
                    DownloadManager.Query query = new DownloadManager.Query();
                    query.setFilterById(enqueue);
                    cursor = manager.query(query);
                    if (cursor.moveToFirst()) {
                        int columnIndex = cursor
                                .getColumnIndex(DownloadManager.COLUMN_STATUS);
                        if (DownloadManager.STATUS_SUCCESSFUL == cursor.getInt(columnIndex)) {
                            System.out.println(fileLength = file.length());
                            if(!(fileLength<=545856)){
                                Snackbar.make(mView, "Download Completed : " + title + ".mp3", Snackbar.LENGTH_LONG).setAction("Play Now", new View.OnClickListener() {
                                    @Override
                                    public void onClick(View v) {
                                        Uri path = Uri.fromFile(file);
                                        Intent intent = new Intent(Intent.ACTION_VIEW);
                                        intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
                                        intent.setDataAndType(path, "audio/mp3");
                                        mContext.startActivity(intent);
                                    }
                                }).show();
                            }else{
                                manager.remove(downloadID);
                                startDownload(link);
                            }
                        }
                    }
                }
            }
        };

        startDownload(link);

    }

    private void startDownload(String newLink) {

        mContext.getApplicationContext().registerReceiver(afterDownload, new IntentFilter(
                DownloadManager.ACTION_DOWNLOAD_COMPLETE));

        manager = (DownloadManager) mContext.getSystemService(Context.DOWNLOAD_SERVICE);
        DownloadManager.Request request = new DownloadManager.Request(Uri.parse(newLink))
                .setAllowedOverMetered(true)
                .setAllowedOverRoaming(true)
                .setDestinationUri(Uri.fromFile(file))
                .setTitle(title);
        request.allowScanningByMediaScanner();
        downloadID = manager.enqueue(request);

    }


}

